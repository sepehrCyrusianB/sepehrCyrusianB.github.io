<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ollama Chat</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; margin-bottom: 10px; }
    .user { color: blue; margin: 5px 0; }
    .bot { color: green; margin: 5px 0; }
  </style>
</head>
<body>
  <h2>Chat with Ollama</h2>
  <div id="chat"></div>

  <input type="text" id="message" placeholder="Type your message..." style="width:70%">
  <button onclick="sendMessage()">Send</button>

  <script>
    async function sendMessage() {
      const input = document.getElementById("message");
      const chat = document.getElementById("chat");
      const text = input.value.trim();
      if (!text) return;

      // show user message
      const userMsg = document.createElement("div");
      userMsg.textContent = "You: " + text;
      userMsg.className = "user";
      chat.appendChild(userMsg);

      // create bot message container
      const botMsg = document.createElement("div");
      botMsg.textContent = "Bot: ";
      botMsg.className = "bot";
      chat.appendChild(botMsg);

      // scroll down
      chat.scrollTop = chat.scrollHeight;

      try {
        const response = await fetch("https://gifts-lc-authorized-culture.trycloudflare.com/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gemma3:4b",
            prompt: text,
            stream: true
          })
        });

        if (!response.body) {
          botMsg.textContent += " [No response body]";
          return;
        }

        const reader = response.body
          .pipeThrough(new TextDecoderStream())
          .getReader();

        let botResponse = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const lines = value.trim().split("\n");
          for (const line of lines) {
            if (!line) continue;
            try {
              const data = JSON.parse(line);
              if (data.response) {
                botResponse += data.response;
                botMsg.textContent = "Bot: " + botResponse;
                chat.scrollTop = chat.scrollHeight;
              }
            } catch (err) {
              console.error("Bad line:", line, err);
            }
          }
        }
      } catch (err) {
        botMsg.textContent += " [Error: " + err + "]";
      }

      input.value = "";
    }
  </script>
</body>
</html>
